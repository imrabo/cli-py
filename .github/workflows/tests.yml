name: imrabo CI & Release

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  release: # New trigger for PyPI publishing
    types: [published]

permissions:
  contents: read # Default read permission for all jobs

jobs:
  test: # Renamed 'build' job to 'test' for clarity
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install development dependencies, including mkdocs, mkdocs-material for docs build
        pip install -e ".[dev]" mkdocs mkdocs-material

    - name: Run Kernel Contract Validation Tests (GATE)
      run: pytest tests/kernel/contracts/

    - name: Run Kernel Lifecycle State Machine Tests (GATE)
      run: pytest tests/kernel/lifecycle/

    - name: Run Kernel Failure Model Tests (GATE)
      run: pytest tests/kernel/failure-model/

    - name: Run CLI Grammar & Parsing Tests (GATE)
      run: pytest tests/cli/grammar/

    - name: Run CLI Backward Compatibility Tests (GATE)
      run: pytest tests/cli/backward-compat/

    - name: Run CLI Daemon Interaction Tests (GATE)
      run: pytest tests/cli/interaction/

    - name: Run Daemon Lifecycle Tests (GATE)
      run: pytest tests/daemon/lifecycle/

    - name: Run Daemon Concurrency Tests (GATE)
      run: pytest tests/daemon/concurrency/
    
    - name: Run Daemon Crash & Recovery Tests (GATE)
      run: pytest tests/daemon/crash-recovery/

    - name: Run Engine Adapter Tests (GATE)
      run: pytest tests/adapters/engine/
    
    - name: Run Model Registry & Artifact Tests (GATE)
      run: pytest tests/registry/

    - name: Run Plugin System Isolation Tests (INFORMATIONAL - for now)
      run: pytest tests/plugins/isolation/

    - name: Run Plugin Capability Registration Tests (INFORMATIONAL - for now)
      run: pytest tests/plugins/capabilities/

    - name: Run Observability Logging Tests (GATE)
      run: pytest tests/observability/logging/

    - name: Run Observability Events Tests (GATE)
      run: pytest tests/observability/events/

    - name: Run Security Tests (GATE)
      run: pytest tests/security/
    
    - name: Run Performance & Resource Tests (INFORMATIONAL)
      run: pytest tests/performance/

    - name: Run Backward Compatibility Tests (Kernel Data) (CRITICAL GATE)
      run: pytest tests/backward-compatibility/

    - name: Build Documentation
      run: .venv/Scripts/python.exe -m mkdocs build # Build docs during tests to catch config errors early
  
  release-build: # New job to build distributions for PyPI
    if: github.event_name == 'release' && github.event.action == 'published'
    runs-on: ubuntu-latest
    needs: [test] # Ensure tests pass before building release
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build release distributions
        run: |
          python -m pip install --upgrade build wheel
          python -m build --sdist --wheel

      - name: Upload distributions artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: dist/

  pypi-publish: # New job to publish to PyPI using trusted publishing
    if: github.event_name == 'release' && github.event.action == 'published'
    runs-on: ubuntu-latest
    needs: [release-build]
    permissions:
      id-token: write # Mandatory for trusted publishing
    environment:
      name: pypi
    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/